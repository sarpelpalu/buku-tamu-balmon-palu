<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Buku Tamu Balmon Palu</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
      body { font-family: 'Geist', sans-serif; background-color: #f8fafc; }
      .hidden { display: none !important; }
      .glass-card { background: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); border-radius: 1rem; }
  </style>
</head>
<body class="text-slate-800 h-screen flex flex-col">

  <div id="login-section" class="flex-1 flex items-center justify-center p-4">
      <div class="glass-card w-full max-w-md p-8">
          <div class="text-center mb-8">
              <h2 class="text-2xl font-bold text-slate-900">Login Admin</h2>
              <p class="text-slate-500 text-sm mt-1">Balai Monitor SFR Kelas II Palu</p>
          </div>
          <form id="login-form" class="space-y-5">
              <div>
                  <label class="block text-sm font-semibold mb-2">Email Admin</label>
                  <input type="email" id="email" required class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all">
              </div>
              <div>
                  <label class="block text-sm font-semibold mb-2">Password</label>
                  <input type="password" id="password" required class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all">
              </div>
              <p id="login-error" class="text-red-500 text-sm hidden">Email atau password salah!</p>
              <button type="submit" id="btn-login" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-all">Masuk</button>
          </form>
      </div>
  </div>

  <div id="dashboard-section" class="hidden flex-1 flex flex-col h-full">
      <nav class="bg-white shadow-sm px-6 py-4 flex justify-between items-center">
          <div>
              <h1 class="font-bold text-xl text-slate-800">Dashboard Buku Tamu</h1>
              <p class="text-sm text-slate-500">Data Pengunjung Balmon Palu</p>
          </div>
          <button id="btn-logout" class="text-red-600 hover:bg-red-50 px-4 py-2 rounded-lg font-medium transition-all">Keluar (Logout)</button>
      </nav>

      <main class="flex-1 p-6 overflow-hidden flex flex-col">
          <div class="mb-4 flex justify-between items-center">
              <h2 class="font-semibold text-lg">Daftar Tamu Terbaru</h2>
              <button id="btn-export" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium shadow-sm transition-all flex items-center gap-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                  Download Excel
              </button>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 overflow-auto">
              <table class="w-full text-left border-collapse">
                  <thead class="bg-slate-50 sticky top-0">
                      <tr>
                          <th class="p-4 font-semibold text-sm text-slate-600 border-b">No</th>
                          <th class="p-4 font-semibold text-sm text-slate-600 border-b">Tanggal</th>
                          <th class="p-4 font-semibold text-sm text-slate-600 border-b">Nama Lengkap</th>
                          <th class="p-4 font-semibold text-sm text-slate-600 border-b">Instansi</th>
                          <th class="p-4 font-semibold text-sm text-slate-600 border-b">Keperluan</th>
                          <th class="p-4 font-semibold text-sm text-slate-600 border-b">No. HP</th>
                      </tr>
                  </thead>
                  <tbody id="table-body" class="divide-y divide-slate-100">
                      <tr><td colspan="6" class="p-8 text-center text-slate-500">Memuat data...</td></tr>
                  </tbody>
              </table>
          </div>
      </main>
  </div>

  <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
      import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
      import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

      // 1. GANTI DENGAN CONFIG ANDA!
      const firebaseConfig = {
          apiKey: "AIzaSyAIO4SFmMfnKOTkntNycRuS9masQhcKQWI",
          authDomain: "buku-tamu-balmon-palu-3161f.firebaseapp.com",
          projectId: "buku-tamu-balmon-palu-3161f",
          storageBucket: "buku-tamu-balmon-palu-3161f.firebasestorage.app",
          messagingSenderId: "660097755644",
          appId: "1:660097755644:web:43ff4deceac07697edea79"

      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // Element UI
      const loginSection = document.getElementById('login-section');
      const dashboardSection = document.getElementById('dashboard-section');
      const loginForm = document.getElementById('login-form');
      const loginError = document.getElementById('login-error');
      const tableBody = document.getElementById('table-body');
      let dataTamuExcel = []; // Menyimpan data untuk diexport

      // 2. Pantau Status Login (Cek apakah user sudah login atau belum)
      onAuthStateChanged(auth, (user) => {
          if (user) {
              // Jika login berhasil
              loginSection.classList.add('hidden');
              dashboardSection.classList.remove('hidden');
              loadDataTamu(); // Tarik data dari database
          } else {
              // Jika belum login / logout
              loginSection.classList.remove('hidden');
              dashboardSection.classList.add('hidden');
          }
      });

      // 3. Proses Login
      loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;
          const btnLogin = document.getElementById('btn-login');

          btnLogin.textContent = "Memproses...";
          btnLogin.disabled = true;
          loginError.classList.add('hidden');

          try {
              await signInWithEmailAndPassword(auth, email, password);
              // Jika sukses, onAuthStateChanged akan otomatis berjalan
          } catch (error) {
              console.error(error);
              loginError.classList.remove('hidden');
          } finally {
              btnLogin.textContent = "Masuk";
              btnLogin.disabled = false;
          }
      });

      // 4. Proses Logout
      document.getElementById('btn-logout').addEventListener('click', () => {
          signOut(auth);
      });

      // 5. Fungsi Mengambil Data dari Firestore
      async function loadDataTamu() {
          try {
              // Ambil data, urutkan dari yang terbaru (descending)
              const q = query(collection(db, "buku_tamu"), orderBy("waktu_submit", "desc"));
              const querySnapshot = await getDocs(q);
              
              tableBody.innerHTML = ''; // Kosongkan tabel loading
              dataTamuExcel = []; // Kosongkan array excel
              let no = 1;

              if(querySnapshot.empty) {
                  tableBody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-500">Belum ada data tamu.</td></tr>';
                  return;
              }

              querySnapshot.forEach((doc) => {
                  const data = doc.data();
                  
                  // Format untuk tabel HTML
                  const tr = document.createElement('tr');
                  tr.className = "hover:bg-slate-50 transition-colors";
                  tr.innerHTML = `
                      <td class="p-4 text-sm">${no}</td>
                      <td class="p-4 text-sm">${data.tanggal || '-'}</td>
                      <td class="p-4 text-sm font-medium text-slate-900">${data.nama || '-'}</td>
                      <td class="p-4 text-sm">${data.instansi || '-'}</td>
                      <td class="p-4 text-sm">${data.keperluan || '-'}</td>
                      <td class="p-4 text-sm">${data.telepon || '-'}</td>
                  `;
                  tableBody.appendChild(tr);

                  // Format untuk Export Excel
                  dataTamuExcel.push({
                      "No": no,
                      "Tanggal Kunjungan": data.tanggal || '-',
                      "Nama Lengkap": data.nama || '-',
                      "Instansi/Perusahaan": data.instansi || '-',
                      "Alamat": data.alamat || '-',
                      "Keperluan": data.keperluan || '-',
                      "Nomor Telepon/WA": data.telepon || '-'
                  });

                  no++;
              });
          } catch (error) {
              console.error("Gagal memuat data:", error);
              tableBody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-red-500">Gagal memuat data. Periksa koneksi atau izin database.</td></tr>';
          }
      }

      // 6. Fungsi Export ke Excel menggunakan SheetJS
      document.getElementById('btn-export').addEventListener('click', () => {
          if (dataTamuExcel.length === 0) {
              alert("Tidak ada data untuk didownload.");
              return;
          }
          
          // Buat lembar kerja (worksheet) baru dari data JSON
          const worksheet = XLSX.utils.json_to_sheet(dataTamuExcel);
          
          // Buat file excel (workbook) baru
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, "Data Tamu");
          
          // Download file dengan nama Data_Tamu_Balmon.xlsx
          XLSX.writeFile(workbook, "Data_Tamu_Balmon.xlsx");
      });
  </script>
</body>
</html>
